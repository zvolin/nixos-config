{ lib, pkgs, config, inputs, ... }:

{
  options.services.tiny-dfr.enable = lib.mkEnableOption "tiny-dfr";

  config = lib.mkIf config.services.tiny-dfr.enable (let
    tiny-dfr = pkgs.callPackage ./package.nix { inherit pkgs inputs; };
  in {
    environment.systemPackages = [ tiny-dfr ];
    systemd.packages = [ tiny-dfr ];
    services.udev.packages = [ tiny-dfr ];

    environment.etc."tiny-dfr/config.toml".text = ''
      # tiny-dfr config template. Do not edit this file directly, instead
      # copy it to /etc/tiny-dfr/config.toml and edit that copy.
      # The daemon will merge those two files, giving preference to the one in /etc
      
      # F{number} keys are shown when Fn is not pressed by default.
      # Set this to true if you want the media keys to be shown without Fn pressed
      MediaLayerDefault = true
      
      # Set this to false if you want to hide the button outline,
      # leaving only the text/logo
      ShowButtonOutlines = false
      
      # Set this to true to slowly shift the entire screen contents.
      # In theory this helps with screen longevity, but macos does not bother doint it
      # Disabling ShowButtonOutlines will make this effect less noticeable to the eye
      EnablePixelShift = false
      
      # Set this to the fontconfig pattern to be used to pick a font for text labels
      # Some examples are:
      # "" - default regular sans-serif font
      # ":bold" - default bold sans-serif font
      # For full reference on accepted values see the fontconfig user guide,
      # section "Font Names"
      # https://www.freedesktop.org/software/fontconfig/fontconfig-user.html
      FontTemplate = ":bold"

      AdaptiveBrightness = false
      ActiveBrightness = 1
      
      # This key defines the contents of the primary layer
      # (the one with F{number} keys)
      # You can change the individual buttons, add, or remove them
      # Any number of keys that is greater than 0 is allowed
      # however rendering will start to break around 24 keys
      PrimaryLayerKeys = [
          # Action defines the key code to send when the button is pressed
          # Text defines the button label
          # Svg specifies the icon to be used for the button.
          # Do not include the .svg extension in the file name.
          # Svgs are looked up in /etc/tiny-dfr first and then in /usr/share/tiny-dfr
          # Only one of Text or Svg is allowed,
          # if both are present, the behavior is undefined.
          # For the list of supported key codes see
          # https://docs.rs/input-linux/latest/input_linux/enum.Key.html
          { Text = "F1",  Action = "F1"  },
          { Text = "F2",  Action = "F2"  },
          { Text = "F3",  Action = "F3"  },
          { Text = "F4",  Action = "F4"  },
          { Text = "F5",  Action = "F5"  },
          { Text = "F6",  Action = "F6"  },
          { Text = "F7",  Action = "F7"  },
          { Text = "F8",  Action = "F8"  },
          { Text = "F9",  Action = "F9"  },
          { Text = "F10", Action = "F10" },
          { Text = "F11", Action = "F11" },
          { Text = "F12", Action = "F12" },
          { Text = "SysRq", Action = "Sysrq" }
      ]
      
      # This key defines the contents of the media key layer
      MediaLayerKeys = [
          { Svg = "brightness_low",  Action = "BrightnessDown" },
          { Svg = "brightness_high", Action = "BrightnessUp"   },
          { Svg = "mic_off",         Action = "MicMute"        },
          { Svg = "search",          Action = "Search"         },
          { Svg = "backlight_low",   Action = "IllumDown"      },
          { Svg = "backlight_high",  Action = "IllumUp"        },
          { Svg = "fast_rewind",     Action = "PreviousSong"   },
          { Svg = "play_pause",      Action = "PlayPause"      },
          { Svg = "fast_forward",    Action = "NextSong"       },
          { Svg = "volume_off",      Action = "Mute"           },
          { Svg = "volume_down",     Action = "VolumeDown"     },
          { Svg = "volume_up",       Action = "VolumeUp"       }
      ]
      '';
  });
}
